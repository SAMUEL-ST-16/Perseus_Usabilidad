<div class="results-dashboard">
  <!-- Header con estadísticas generales -->
  <div class="dashboard-header">
    <h2 class="dashboard-title">
      <svg class="title-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
      </svg>
      Resultados del Análisis
    </h2>

    <div class="stats-grid">
      <!-- Comentarios Procesados -->
      <div class="stat-card stat-primary">
        <svg class="stat-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
        </svg>
        <div class="stat-content">
          <div class="stat-value">{{ results.total_comments }}</div>
          <div class="stat-label">Comentarios Procesados</div>
        </div>
      </div>

      <!-- Requisitos Encontrados -->
      <div class="stat-card stat-success">
        <svg class="stat-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <div class="stat-content">
          <div class="stat-value">{{ results.valid_requirements }}</div>
          <div class="stat-label">Requisitos Encontrados</div>
        </div>
      </div>

      <!-- Tasa de Éxito -->
      <div class="stat-card stat-info">
        <svg class="stat-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
        </svg>
        <div class="stat-content">
          <div class="stat-value">{{ successRate() | number: '1.1-1' }}%</div>
          <div class="stat-label">Tasa de Detección</div>
        </div>
      </div>

      <!-- Tiempo de Procesamiento -->
      <div class="stat-card stat-warning">
        <svg class="stat-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
        </svg>
        <div class="stat-content">
          <div class="stat-value">{{ formatTime(results.processing_time_ms) }}</div>
          <div class="stat-label">Tiempo de Procesamiento</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs para cambiar entre tabla y estadísticas -->
  <div class="dashboard-tabs">
    <button
      class="tab-button"
      [class.active]="activeTab() === 'table'"
      (click)="setActiveTab('table')">
      <svg class="tab-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
      </svg>
      Tabla de Resultados
    </button>
    <button
      class="tab-button"
      [class.active]="activeTab() === 'stats'"
      (click)="setActiveTab('stats')">
      <svg class="tab-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
      </svg>
      Estadísticas
    </button>
    @if (pdfBlob) {
      <button class="export-button pdf-button" (click)="downloadPDF()">
        <svg class="tab-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
        </svg>
        Descargar PDF
      </button>
    }
  </div>

  <!-- Vista de Tabla -->
  @if (activeTab() === 'table') {
    <div class="table-container">
      @if (results.valid_requirements > 0) {
        <table class="results-table">
          <thead>
            <tr>
              <th class="col-icon">#</th>
              <th class="col-comment">Comentario</th>
              <th class="col-subchar">Subcaracterística</th>
              <th class="col-score">Score Binario</th>
              <th class="col-score">Score Multiclase</th>
              <th class="col-description">Descripción</th>
            </tr>
          </thead>
          <tbody>
            @for (req of results.requirements; track req.comment; let i = $index) {
              @if (req.is_requirement) {
                <tr class="table-row" [attr.data-subchar]="req.subcharacteristic">
                  <td class="col-icon">
                    <div class="row-number">{{ i + 1 }}</div>
                  </td>
                  <td class="col-comment">
                    <div class="comment-text">{{ req.comment }}</div>
                  </td>
                  <td class="col-subchar">
                    <div class="subchar-badge" [style.background-color]="SUBCHARACTERISTIC_COLORS[req.subcharacteristic || ''] + '20' || '#667eea20'">
                      <svg class="badge-icon" [style.color]="SUBCHARACTERISTIC_COLORS[req.subcharacteristic || ''] || '#667eea'" fill="none" viewBox="0 0 24 24" stroke="currentColor" [innerHTML]="SUBCHARACTERISTIC_ICONS[req.subcharacteristic || ''] || ''">
                      </svg>
                      <span class="badge-text" [style.color]="SUBCHARACTERISTIC_COLORS[req.subcharacteristic || ''] || '#667eea'">{{ req.subcharacteristic }}</span>
                    </div>
                  </td>
                  <td class="col-score">
                    <div class="score-badge" [ngClass]="getScoreClass(req.binary_score)">
                      {{ formatScore(req.binary_score) }}
                    </div>
                  </td>
                  <td class="col-score">
                    <div class="score-badge" [ngClass]="getScoreClass(req.multiclass_score)">
                      {{ formatScore(req.multiclass_score) }}
                    </div>
                  </td>
                  <td class="col-description">
                    <div class="description-text">{{ req.description || 'N/A' }}</div>
                  </td>
                </tr>
              }
            }
          </tbody>
        </table>
      } @else {
        <div class="no-results">
          <svg class="no-results-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <h3>No se encontraron requisitos de usabilidad</h3>
          <p>Los comentarios procesados no contienen requisitos de usabilidad según los modelos BERT.</p>
        </div>
      }
    </div>
  }

  <!-- Vista de Estadísticas -->
  @if (activeTab() === 'stats') {
    <div class="stats-container">
      @if (subcharacteristicStats().length > 0) {
        <div class="stats-content">
          <!-- Gráfico de barras -->
          <div class="chart-section">
            <h3 class="section-title">Distribución por Subcaracterística</h3>
            <div class="bar-chart">
              @for (stat of subcharacteristicStats(); track stat.name) {
                <div class="chart-item">
                  <div class="chart-label">
                    <svg class="label-icon" [style.color]="stat.color" fill="none" viewBox="0 0 24 24" stroke="currentColor" [innerHTML]="stat.icon">
                    </svg>
                    <span class="label-text">{{ stat.name }}</span>
                    <span class="label-count">({{ stat.count }})</span>
                  </div>
                  <div class="chart-bar-container">
                    <div
                      class="chart-bar"
                      [style.width.%]="stat.percentage"
                      [style.background-color]="stat.color">
                      <span class="bar-percentage">{{ stat.percentage | number: '1.1-1' }}%</span>
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>

          <!-- Cards de estadísticas detalladas -->
          <div class="detailed-stats">
            <h3 class="section-title">Detalle por Subcaracterística</h3>
            <div class="stats-cards-grid">
              @for (stat of subcharacteristicStats(); track stat.name) {
                <div class="detailed-stat-card" [style.border-color]="stat.color">
                  <div class="card-header" [style.background-color]="stat.color + '20'">
                    <svg class="card-icon" [style.color]="stat.color" fill="none" viewBox="0 0 24 24" stroke="currentColor" [innerHTML]="stat.icon">
                    </svg>
                    <span class="card-title" [style.color]="stat.color">{{ stat.name }}</span>
                  </div>
                  <div class="card-body">
                    <div class="card-stat">
                      <span class="stat-label">Requisitos:</span>
                      <span class="stat-value">{{ stat.count }}</span>
                    </div>
                    <div class="card-stat">
                      <span class="stat-label">Porcentaje:</span>
                      <span class="stat-value">{{ stat.percentage | number: '1.1-1' }}%</span>
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>
        </div>
      } @else {
        <div class="no-results">
          <svg class="no-results-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
          <h3>No hay estadísticas disponibles</h3>
          <p>No se encontraron requisitos de usabilidad para generar estadísticas.</p>
        </div>
      }
    </div>
  }
</div>
